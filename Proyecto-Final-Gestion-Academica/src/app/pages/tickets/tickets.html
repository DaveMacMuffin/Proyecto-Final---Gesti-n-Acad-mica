<div class="flex flex-col min-h-screen">
    <app-navbar></app-navbar>
    <div class="flex flex-1">
        <app-sidebar></app-sidebar>
        <main class="flex-1 p-6 bg-background">
            <div class="max-w-7xl mx-auto tickets-wrapper">

                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-foreground mb-2">Tickets & Incidencias</h1>
                        <p class="text-muted-foreground">
                            Gestión centralizada de solicitudes y reportes
                        </p>
                    </div>
                    <button data-toggle="modal" data-target="#modalAgregarTicket"
                        class="btn-ticket btn btn-secondary">
                        <i class="fa-solid fa-plus"></i>
                        Nuevo Ticket
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-card rounded-lg shadow-sm p-4">
                        <div class="flex items-center justify-between pb-2">
                            <h3 class="text_tickets text-sm font-medium text-muted-foreground">Pendientes</h3>
                            <i class="fa-solid fa-triangle-exclamation fa-5x"></i>

                        </div>
                        <div class="text-3xl font-bold">{{tot_pendientes}}</div>
                    </div>

                    <div class="bg-card rounded-lg shadow-sm p-4">
                        <div class="flex items-center justify-between pb-2">
                            <h3 class="text_tickets text-sm font-medium text-muted-foreground">En Proceso</h3>
                            <i class="fa-solid fa-spinner fa-5x"></i>                            
                        </div>
                        <div class="text-3xl font-bold">{{tot_proceso}}</div>
                    </div>

                    <div class="bg-card rounded-lg shadow-sm p-4">
                        <div class="flex items-center justify-between pb-2">
                            <h3 class="text_tickets text-sm font-medium text-muted-foreground">Resueltos</h3>
                            <i class="fa-solid fa-check fa-5x" ></i>
                        </div>
                        <div class="text-3xl font-bold">{{tot_resueltos}}</div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="relative search-flex-1">
                        <input
                            placeholder="Buscar por profesor, categoría, prioridad o estado..."
                            [(ngModel)]="terminoBusqueda"
                            (input)="searchFilterTicket()"
                            class="tickets-search-input"
                        />
                    </div>

                    <select
                        [(ngModel)]="categoriaSeleccionada"
                        (change)="aplicarFiltrosTipo()"
                        class="tickets-select-filter"
                    >
                        <option value="Todas las categorías">Todas las categorías</option>
                        <option value="Cambio de calificación">Cambio Calificación</option>
                        <option value="Cambio de fecha de examen">Cambio Fecha Examen</option>
                        <option value="Integridad académica">Integridad Académica</option>
                        <option value="Reporte disciplinar">Reporte Disciplinar</option>
                        <option value="Incidencia de pago">Incidencia de Pago</option>
                    </select>

                    <select
                        [(ngModel)]="ordenSeleccionado"
                        (change)="aplicarFiltrosFecha()"
                        class="tickets-select-filter"
                    >
                        <option value="Reciente">Más reciente</option>
                        <option value="Antiguo">Más antiguo</option>
                        <option value="Prioridad">Por prioridad</option>
                    </select>
                </div>

                <div class="bg-card rounded-lg shadow-sm">
                    <div class="p-6 border-b border-border">
                        <h3 class="text-lg font-semibold">Lista de Tickets</h3>
                    </div>
                    <div class="p-6">
                        <div class="tickets-list-scroll">
                            <div *ngFor="let ticket of ticketsFiltrados let i = index"
                                class="flex items-center justify-between p-4 border border-border rounded-lg">
                                <div class="flex items-center gap-4 tickets-row-main">
                                    <div class="flex flex-col">
                                        <span class="tickets-index">{{i + 1}}</span>
                                        <span class="text-xs text-muted-foreground">{{ticket.fecha}}</span>
                                    </div>

                                    <div class="tickets-info">
                                        <p class="font-semibold">{{ticket.tipo}}</p>
                                        <p class="text-sm text-muted-foreground">{{ticket.profesor}}</p>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <span
                                            class="badge-prioridad-base"
                                            [ngClass]="
                                                ticket.prioridad === 'Alta'
                                                    ? 'badge-prioridad-alta'
                                                    : ticket.prioridad === 'Media'
                                                        ? 'badge-prioridad-media'
                                                        : 'badge-prioridad-baja'
                                            "
                                        >
                                            {{ticket.prioridad}}
                                        </span>
                                        <span
                                            class="badge-status-base"
                                            [ngClass]="
                                                ticket.status === 'Pendiente'
                                                    ? 'badge-status-pendiente'
                                                    : ticket.status === 'En Proceso'
                                                        ? 'badge-status-proceso'
                                                        : 'badge-status-resuelto'
                                            "
                                        >
                                            {{ticket.status}}
                                        </span>
                                    </div>
                                </div>

                                <button
                                    data-toggle="modal"
                                    data-target="#modalEditarTicket"
                                    (click)="abrirModalEditar(ticket)"
                                    class="tickets-icon-button"
                                >
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button
                                    class="btn btn-danger tickets-icon-button"
                                    (click)="eliminarRegistro(i, ticket)"
                                >
                                    <img src="\img\icons8-basura-24.png" alt="Eliminar"> 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="modalAgregarTicket" tabindex="-1" role="dialog"
        aria-labelledby="modalAgregarTicketLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAgregarTicketLabel">Añadir ticket</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tipo de ticket</label>
                        <select class="form-select" name="tipo" [(ngModel)]="nuevoTicket.tipo">
                            <option value="Cambio de calificación"> Cambio de Calificación</option>
                            <option value="Incidencia de pago">Incidencia de Pago</option>
                            <option value="Reporte diciplinar">Reporte Diciplinar</option>
                            <option value="Cambio de fecha de examen">Cambio de fecha de Examen</option>
                            <option value="Integridad académica">Integridad Académica</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción del Ticket</label>
                        <input class="form-control" name="descripcion" [(ngModel)]="nuevoTicket.descripcion"
                            placeholder="Ingrese la descripcion del ticket">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Prioridad</label>
                        <select class="form-select" name="prioridad" [(ngModel)]="nuevoTicket.prioridad">
                            <option value="Alta"> Alta</option>
                            <option value="Media">Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>Docente</label>
                        <select class="form-select" [(ngModel)]="nuevoTicket.id_docente" name="docente">
                            <option [ngValue]="null">Selecciona un docente</option>
                            <option *ngFor="let d of listaDocentes" [ngValue]="d.id_docente">
                                {{ d.nombre }} ({{ d.academia }})
                            </option>
                        </select>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn-ticket btn btn-secondary" (click)="guardarTicket()"> Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditarTicket" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Actualizar estado</h5>
                </div>

                <div class="modal-body">

                    <label class="form-label">Estado del ticket</label>
                    <select class="form-select" [(ngModel)]="ticketEditar.status">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Resuelto">Resuelto</option>
                    </select>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" (click)="actualizarEstadoTicket()"> Save
                        changes</button>
                </div>
            </div>
        </div>
    </div>
    <app-footer></app-footer>
</div>
